<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wing Ya Chifa - Sistema de Gesti√≥n</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* ESTILOS GENERALES Y DE DISE√ëO */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f5f5; height: 100vh; display: flex; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background-color: #1a1a1a; color: white; height: 100vh; padding: 20px 0; display: flex; flex-direction: column; overflow-y: auto; }
        .logo-container { display: flex; align-items: center; justify-content: center; padding: 20px; margin-bottom: 30px; border-bottom: 1px solid #333; }
        .logo { width: 60px; height: 60px; background-color: #ff3333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; color: white; margin-right: 10px; }
        .logo-text { font-size: 18px; font-weight: bold; color: #ff3333; }
        .menu-list { flex-grow: 1; }

        /* ROLES: Ocultos por defecto */
        .menu-item.role-chef, .menu-item.role-encargado-almacen, .menu-item.role-jefe-almacen, .menu-item.role-compras, .menu-item.role-due√±o { display: none; }

        .menu-item { padding: 15px 25px; display: flex; align-items: center; color: #ddd; text-decoration: none; transition: all 0.3s; border-left: 3px solid transparent; cursor: pointer; }
        .menu-item:hover, .menu-item.active { background-color: #333; color: white; border-left: 3px solid #ff3333; }
        .menu-item i { margin-right: 15px; font-size: 18px; width: 20px; text-align: center; }
        .sidebar-footer { border-top: 1px solid #333; padding-top: 10px; }
        .sidebar-footer .menu-item.logout:hover { color: #ff3333; }

        /* CONTENIDO PRINCIPAL */
        .main-container { flex: 1; display: flex; flex-direction: column; background-color: #f8f8f8; overflow-y: auto; }
        .header { background-color: white; padding: 15px 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .content-card { background-color: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); padding: 30px; }
        .view { display: none; padding: 30px; animation: fadeIn 0.4s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* COMPONENTES UI */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-grid-dynamic { display: grid; grid-template-columns: 2fr 1fr auto; gap: 15px; align-items: flex-end; }
        .form-group { margin-bottom: 20px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { padding: 12px 25px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-primary { background-color: #ffc107; color: #333; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-sm { padding: 8px 12px; font-size: 14px; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th { background-color: #f2f2f2; padding: 12px; text-align: left; }
        .data-table td { padding: 12px; border-bottom: 1px solid #ddd; }
        .no-records { text-align: center; padding: 20px; color: #999; font-style: italic; }

        /* MODALES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 450px; text-align: center; transform: scale(0.9); transition: 0.3s; }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-icon { font-size: 50px; margin-bottom: 20px; }
        .fa-check-circle { color: #28a745; } .fa-times-circle { color: #dc3545; } .fa-exclamation-triangle { color: #ffc107; } .fa-question-circle { color: #0d6efd; }
        .modal-buttons-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo-container">
            <div class="logo">WY</div>
            <div class="logo-text">Wing Ya Chifa</div>
        </div>
        <div class="menu-list">
            <a class="menu-item active" data-view="view-welcome"><i class="fas fa-home"></i><span>Inicio</span></a>
            
            <a class="menu-item role-chef" data-view="view-request"><i class="fas fa-file-alt"></i><span>Registrar Solicitud</span></a>
            <a class="menu-item role-chef" data-view="view-verify-dispatch"><i class="fas fa-box-check"></i><span>Verificar Despacho</span></a>
            
            <a class="menu-item role-jefe-almacen" data-view="view-approve-request"><i class="fas fa-tasks"></i><span>Aprobar Solicitudes</span></a>
            
            <a class="menu-item role-encargado-almacen" data-view="view-dispatch"><i class="fas fa-truck"></i><span>Registrar Despacho</span></a>
            <a class="menu-item role-encargado-almacen" data-view="view-purchase-order"><i class="fas fa-clipboard-list"></i><span>Orden de Compra</span></a>
            <a class="menu-item role-encargado-almacen" data-view="view-entry"><i class="fas fa-dolly-flatbed"></i><span>Registrar Entrada</span></a>
            <a class="menu-item role-encargado-almacen" data-view="view-stock"><i class="fas fa-boxes"></i><span>Actualizar Stock</span></a>
            <a class="menu-item role-encargado-almacen" data-view="view-merma"><i class="fas fa-exclamation-triangle"></i><span>Registrar Merma</span></a>
            
            <a class="menu-item role-compras" data-view="view-validate-order"><i class="fas fa-check-double"></i><span>Validar √ìrdenes</span></a>
            
            <a class="menu-item role-jefe-almacen role-encargado-almacen" data-view="view-gestionar-insumos"><i class="fas fa-book"></i><span>Gestionar Insumos</span></a>
            
            <a class="menu-item role-jefe-almacen role-due√±o" data-view="view-history"><i class="fas fa-history"></i><span>Historial</span></a>
        </div>
        <div class="sidebar-footer">
            <a class="menu-item" data-view="view-settings"><i class="fas fa-cog"></i><span>Configuraci√≥n</span></a>
            <a class="menu-item logout" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesi√≥n</span></a>
        </div>
    </nav>

    <main class="main-container">
        <header class="header">
            <h1 id="page-title">Panel de Control</h1>
            <div class="user-info"><i class="fas fa-user-circle"></i><span>Usuario</span></div>
        </header>

        <section id="view-welcome" class="view active">
            <div class="content-card welcome-container" style="text-align: center;">
                <div class="brand-logo-large" style="margin: 0 auto 40px; width: 150px; height: 150px; background: #ff3333; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">WY</div>
                <h1 style="color: #ff3333; font-size: 60px;">BIENVENIDO</h1>
                <p style="color: #666; font-size: 18px;">Sistema de Gesti√≥n de Insumos - Wing Ya Chifa</p>
            </div>
        </section>

        <section id="view-request" class="view">
            <div class="content-card">
                <h2 style="color: #ff3333; margin-bottom: 25px;">Registrar Solicitud de Insumos</h2>
                <form id="form-solicitud">
                    <div class="form-grid">
                        <div class="form-group"><label>Solicitante</label><input type="text" id="requester-name" class="form-control" readonly></div>
                        <div class="form-group"><label>Cargo</label><input type="text" id="requester-position" class="form-control" readonly></div>
                    </div>
                    <div class="form-grid-dynamic">
                        <div class="form-group"><label>Insumo</label><select id="request-insumo-select" class="form-control"><option value="">Cargando...</option></select></div>
                        <div class="form-group"><label>Cantidad</label><input type="number" id="request-insumo-qty" class="form-control" min="1"></div>
                        <div class="form-group"><button type="button" id="btn-add-insumo" class="btn btn-primary" style="width: 100%;">+ A√±adir</button></div>
                    </div>
                    <h3 style="margin-top: 20px;">Insumos Solicitados:</h3>
                    <table class="data-table"><thead><tr><th>Insumo</th><th>Cantidad</th></tr></thead><tbody id="request-items-table"></tbody></table>
                    <div class="form-group full-width" style="margin-top: 20px;"><label>Comentarios</label><textarea id="request-comments" class="form-control"></textarea></div>
                    <button type="submit" class="btn btn-success" style="margin-top: 20px;">Registrar Solicitud Completa</button>
                </form>
            </div>
        </section>

        <section id="view-approve-request" class="view">
            <div class="content-card">
                <h2 style="color: #ff3333; margin-bottom: 25px;">Aprobar Solicitudes</h2>
                <table class="data-table"><thead><tr><th>ID</th><th>Fecha</th><th>Solicitante</th><th>Insumos</th><th>Acci√≥n</th></tr></thead><tbody id="approve-table-body"></tbody></table>
            </div>
        </section>

        <section id="view-dispatch" class="view">
            <div class="content-card">
                <h2 style="color: #ff3333; margin-bottom: 25px;">Registrar Despacho</h2>
                <div class="form-group"><label>Encargado</label><input type="text" id="dispatch-requester" class="form-control" readonly></div>
                <h3>Seleccione una Solicitud Aprobada:</h3>
                <div id="dispatch-list-container"><p class="no-records">Cargando...</p></div>
            </div>
        </section>

        <section id="view-verify-dispatch" class="view">
            <div class="content-card">
                <h2 style="color: #ff3333; margin-bottom: 25px;">Verificar Recepci√≥n</h2>
                <table class="data-table"><thead><tr><th>ID</th><th>Fecha</th><th>Despachado por</th><th>Insumos</th><th>Acci√≥n</th></tr></thead><tbody id="verify-dispatch-table-body"></tbody></table>
            </div>
        </section>

        <section id="view-purchase-order" class="view">
            <div class="content-card">
                <h2 style="color: #ff3333; margin-bottom: 25px;">Generar Orden de Compra</h2>
                <form id="form-orden-compra">
                    <div class="form-group"><label>Encargado</label><input type="text" id="manager-name" class="form-control" readonly></div>
                    <h3>Insumos con Stock Bajo (Autom√°tico):</h3>
                    <table class="data-table"><thead><tr><th>Producto</th><th>Stock Actual</th><th>M√≠nimo</th><th>Comprar</th></tr></thead><tbody id="po-table-body"></tbody></table>
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Generar Orden</button>
                </form>
            </div>
        </section>

        <section id="view-validate-order" class="view">
            <div class="content-card">
                <h2 style="color: #ff3333; margin-bottom: 25px;">Validar √ìrdenes</h2>
                <table class="data-table"><thead><tr><th>ID</th><th>Fecha</th><th>Solicitante</th><th>Insumos</th><th>Acci√≥n</th></tr></thead><tbody id="validate-table-body"></tbody></table>
            </div>
        </section>

        <section id="view-entry" class="view">
            <div class="content-card">
                <h2 style="color: #ff3333; margin-bottom: 25px;">Registrar Entrada</h2>
                <table class="data-table"><thead><tr><th>ID</th><th>Validada por</th><th>Insumos</th><th>Acci√≥n</th></tr></thead><tbody id="entry-table-body"></tbody></table>
            </div>
        </section>

        <section id="view-gestionar-insumos" class="view">
            <div class="content-card">
                <h2 style="color: #ff3333; margin-bottom: 25px;">Gestionar Cat√°logo</h2>
                <form id="form-crear-insumo">
                    <div class="form-grid"><div class="form-group"><label>Nombre</label><input type="text" id="insumo-nombre" class="form-control" required></div><div class="form-group"><label>Categor√≠a</label><input type="text" id="insumo-categoria" class="form-control" required></div></div>
                    <div class="form-grid"><div class="form-group"><label>Stock</label><input type="number" id="insumo-stock-actual" class="form-control" value="0" required></div><div class="form-group"><label>M√≠nimo</label><input type="number" id="insumo-stock-minimo" class="form-control" value="5" required></div></div>
                    <div class="form-group"><label>Unidad</label><input type="text" id="insumo-unidad" class="form-control" required></div>
                    <button type="submit" class="btn btn-success">Crear Insumo</button>
                </form>
                <hr style="margin: 30px 0;">
                <h3>Cat√°logo Actual</h3>
                <table class="data-table"><thead><tr><th>ID</th><th>Nombre</th><th>Stock</th><th>Acci√≥n</th></tr></thead><tbody id="gestionar-insumos-table"></tbody></table>
            </div>
        </section>

        <section id="view-merma" class="view">
            <div class="content-card">
                <h2 style="color: #ff3333; margin-bottom: 25px;">Registrar Merma</h2>
                <form id="form-merma">
                    <div class="form-grid">
                        <div class="form-group"><label>Insumo</label><select id="merma-insumo-select" class="form-control" required><option>Cargando...</option></select></div>
                        <div class="form-group"><label>Cantidad</label><input type="number" id="merma-cantidad" class="form-control" required></div>
                    </div>
                    <div class="form-group"><label>Motivo</label><textarea id="merma-motivo" class="form-control" required></textarea></div>
                    <button type="submit" class="btn btn-danger">Registrar Merma</button>
                </form>
            </div>
        </section>

        <section id="view-history" class="view">
            <div class="content-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #ff3333; margin: 0;">Historial de movimientos</h2>
                    <button id="btn-exportar-pdf" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Exportar a PDF</button>
                </div>
                <table class="data-table" id="tabla-historial-completa"><thead><tr><th>Fecha</th><th>Producto</th><th>Cantidad</th><th>Tipo</th><th>Observaci√≥n</th></tr></thead><tbody id="history-table-body"></tbody></table>
            </div>
        </section>
        
        <section id="view-stock" class="view"><div class="content-card"><h2>Stock Actual</h2><table class="data-table"><tbody id="stock-table-body"></tbody></table></div></section>
        
        <section id="view-settings" class="view"><div class="content-card"><h2>Configuraci√≥n</h2><p>Panel de usuario</p></div></section>
    </main>

    <div class="modal-overlay" id="custom-alert-modal"><div class="modal-box"><div class="modal-icon"><i class="fas fa-check-circle"></i><i class="fas fa-times-circle"></i></div><h2 class="modal-title" id="custom-alert-title"></h2><p class="modal-message" id="custom-alert-message"></p><button class="modal-button" id="custom-alert-button">Aceptar</button></div></div>
    <div class="modal-overlay" id="custom-confirm-modal"><div class="modal-box"><div class="modal-icon"><i class="fas fa-question-circle" style="display:block"></i></div><h2>Confirmaci√≥n</h2><p id="custom-confirm-message"></p><div class="modal-buttons-container"><button class="btn btn-secondary" id="custom-confirm-btn-cancel">Cancelar</button><button class="btn btn-primary" id="custom-confirm-btn-accept">Aceptar</button></div></div></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. UTILIDADES Y MODALES ---
        const alertOverlay = document.getElementById('custom-alert-modal');
        const alertTitle = document.getElementById('custom-alert-title');
        const alertMsg = document.getElementById('custom-alert-message');
        const alertBtn = document.getElementById('custom-alert-button');
        
        function showCustomAlert(msg, type='error') {
            const iconCheck = alertOverlay.querySelector('.fa-check-circle');
            const iconTimes = alertOverlay.querySelector('.fa-times-circle');
            if(type==='success'){ iconCheck.style.display='block'; iconTimes.style.display='none'; alertTitle.textContent='¬°√âxito!'; alertBtn.className='modal-button modal-success'; }
            else { iconCheck.style.display='none'; iconTimes.style.display='block'; alertTitle.textContent='Error'; alertBtn.className='modal-button modal-error'; }
            alertMsg.textContent = msg; alertOverlay.classList.add('active');
        }
        alertBtn.onclick = () => alertOverlay.classList.remove('active');

        const confirmOverlay = document.getElementById('custom-confirm-modal');
        let resolveConfirm;
        function showCustomConfirm(msg) {
            return new Promise((resolve) => {
                document.getElementById('custom-confirm-message').textContent = msg;
                confirmOverlay.classList.add('active');
                resolveConfirm = resolve;
            });
        }
        document.getElementById('custom-confirm-btn-accept').onclick = () => { confirmOverlay.classList.remove('active'); if(resolveConfirm) resolveConfirm(true); };
        document.getElementById('custom-confirm-btn-cancel').onclick = () => { confirmOverlay.classList.remove('active'); if(resolveConfirm) resolveConfirm(false); };

        // --- 2. AUTENTICACI√ìN ---
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));
        if (!token || !user) { window.location.href = 'login.html'; return; }
        document.querySelector('.header .user-info span').textContent = `${user.nombre} (${user.rol})`;

        // --- 3. ROLES ---
        function setupRoleVisibility(rol) {
            document.querySelectorAll('[class*="role-"]').forEach(el => el.style.display = 'none');
            const r = rol.toLowerCase().trim();
            if(r === 'chef de cocina') document.querySelectorAll('.role-chef').forEach(el => el.style.display = 'flex');
            else if(r === 'encargado de almacen') document.querySelectorAll('.role-encargado-almacen').forEach(el => el.style.display = 'flex');
            else if(r === 'jefe de almacen') document.querySelectorAll('.role-jefe-almacen').forEach(el => el.style.display = 'flex');
            else if(r === 'encargado de compras') document.querySelectorAll('.role-compras').forEach(el => el.style.display = 'flex');
            else if(r === 'due√±o') document.querySelectorAll('.role-due√±o').forEach(el => el.style.display = 'flex');
        }
        setupRoleVisibility(user.rol);

        // --- 4. CLIENTE API (Fetch Wrapper) ---
        async function apiFetch(endpoint, options = {}) {
            options.headers = { ...options.headers, 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            // RUTA RELATIVA para que funcione en Vercel
            const res = await fetch(`/api${endpoint}`, options);
            if (!res.ok) { const err = await res.json(); throw new Error(err.message || 'Error de servidor'); }
            return res.json();
        }

        // --- 5. L√ìGICA DE VISTAS ---
        const views = document.querySelectorAll('.view');
        const pageTitle = document.getElementById('page-title');
        const titles = { 'view-welcome':'Inicio', 'view-request':'Solicitud', 'view-history':'Historial' }; // Agrega los dem√°s t√≠tulos si quieres

        document.querySelectorAll('.menu-item[data-view]').forEach(item => {
            item.addEventListener('click', async function(e) {
                e.preventDefault();
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                const viewId = this.getAttribute('data-view');
                views.forEach(v => v.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                pageTitle.textContent = titles[viewId] || 'Panel de Control';

                // Cargar datos seg√∫n vista
                if(viewId === 'view-history') cargarHistorial();
                if(viewId === 'view-validate-order') cargarOrdenesPendientes();
                if(viewId === 'view-entry') cargarOrdenesValidadas();
                if(viewId === 'view-approve-request') cargarSolicitudesPendientes();
                if(viewId === 'view-verify-dispatch') cargarDespachosPendientes();
                if(viewId === 'view-stock') cargarStock();
                if(viewId === 'view-purchase-order') { document.getElementById('manager-name').value = user.nombre; cargarOrdenesStockBajo(); }
                if(viewId === 'view-request') { document.getElementById('requester-name').value = user.nombre; document.getElementById('requester-position').value = user.rol; cargarInsumosParaSolicitud(); }
                if(viewId === 'view-dispatch') { document.getElementById('dispatch-requester').value = user.nombre; cargarSolicitudesAprobadasParaDespacho(); }
                if(viewId === 'view-merma') cargarInsumosParaMerma();
                if(viewId === 'view-gestionar-insumos') cargarGestionarInsumos();
            });
        });

        document.getElementById('logout-btn').addEventListener('click', () => { localStorage.clear(); window.location.href = 'login.html'; });

        // --- 6. FUNCIONES DEL NEGOCIO ---

        async function cargarHistorial() {
            try {
                const data = await apiFetch('/historial');
                document.getElementById('history-table-body').innerHTML = data.length ? data.map(m => `<tr><td>${new Date(m.createdAt).toLocaleString()}</td><td>${m.insumo.nombre}</td><td>${m.cantidad}</td><td>${m.tipo}</td><td>${m.motivo||'-'}</td></tr>`).join('') : '<tr><td colspan="5" class="no-records">Sin registros</td></tr>';
            } catch (e) { console.error(e); }
        }

        async function cargarInsumosParaSolicitud() {
            try {
                const data = await apiFetch('/insumos');
                document.getElementById('request-insumo-select').innerHTML = '<option value="">-- Seleccione --</option>' + data.map(i => `<option value="${i.id}" data-nombre="${i.nombre}">${i.nombre} (Stock: ${i.stock_actual})</option>`).join('');
            } catch (e) { console.error(e); }
        }

        // Solicitud del Chef
        let insumosSol = [];
        document.getElementById('btn-add-insumo').addEventListener('click', () => {
            const sel = document.getElementById('request-insumo-select');
            const id = sel.value, nom = sel.options[sel.selectedIndex]?.dataset.nombre, qty = document.getElementById('request-insumo-qty').value;
            if(!id || !qty) return showCustomAlert('Datos incompletos');
            insumosSol.push({ id_insumo: id, nombre: nom, cantidad: qty });
            document.getElementById('request-items-table').innerHTML = insumosSol.map(i => `<tr><td>${i.nombre}</td><td>${i.cantidad}</td></tr>`).join('');
        });
        document.getElementById('form-solicitud').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { await apiFetch('/solicitudes', { method: 'POST', body: JSON.stringify({ insumos: insumosSol, comentarios: document.getElementById('request-comments').value }) }); showCustomAlert('Registrado', 'success'); insumosSol=[]; document.getElementById('form-solicitud').reset(); } catch (e) { showCustomAlert(e.message); }
        });

        // Aprobar
        async function cargarSolicitudesPendientes() {
            try { const data = await apiFetch('/solicitudes/pendientes'); document.getElementById('approve-table-body').innerHTML = data.map(s => `<tr><td>${s.id}</td><td>${new Date(s.createdAt).toLocaleDateString()}</td><td>${s.solicitante.nombre}</td><td>${s.insumos.map(i=>i.nombre).join(', ')}</td><td><button class="btn btn-success btn-sm act-btn" data-id="${s.id}" data-a="aprobar">‚úì</button> <button class="btn btn-danger btn-sm act-btn" data-id="${s.id}" data-a="rechazar">‚úï</button></td></tr>`).join(''); } catch(e){}
        }
        document.getElementById('approve-table-body').addEventListener('click', async (e) => {
            const btn = e.target.closest('.act-btn');
            if(btn && await showCustomConfirm(`¬ø${btn.dataset.a} solicitud?`)) {
                try { await apiFetch(`/solicitudes/${btn.dataset.id}`, { method: 'PATCH', body: JSON.stringify({ estado: btn.dataset.a==='aprobar'?'Aprobada':'Rechazada' }) }); showCustomAlert('Hecho', 'success'); cargarSolicitudesPendientes(); } catch(e) { showCustomAlert(e.message); }
            }
        });

        // Despacho
        async function cargarSolicitudesAprobadasParaDespacho() {
            try { const data = await apiFetch('/solicitudes/aprobadas'); document.getElementById('dispatch-list-container').innerHTML = `<table class="data-table"><thead><tr><th>ID</th><th>Detalle</th><th>Acci√≥n</th></tr></thead><tbody>${data.map(s => `<tr><td>${s.id}</td><td>${s.insumos.map(i=>i.nombre).join(', ')}</td><td><button class="btn btn-primary btn-sm disp-btn" data-id="${s.id}">Despachar</button></td></tr>`).join('')}</tbody></table>`; } catch(e){}
        }
        document.addEventListener('click', async (e) => {
            if(e.target.classList.contains('disp-btn') && await showCustomConfirm('¬øDespachar?')) {
                try { await apiFetch('/despachos', { method: 'POST', body: JSON.stringify({ id_solicitud: e.target.dataset.id }) }); showCustomAlert('Despachado', 'success'); cargarSolicitudesAprobadasParaDespacho(); } catch(e) { showCustomAlert(e.message); }
            }
        });

        // Verificar
        async function cargarDespachosPendientes() {
            try { const data = await apiFetch('/despachos/pendientes-verificacion'); document.getElementById('verify-dispatch-table-body').innerHTML = data.map(d => `<tr><td>${d.id}</td><td>${new Date(d.createdAt).toLocaleDateString()}</td><td>${d.encargado.nombre}</td><td>${d.insumos.map(i=>i.nombre).join(', ')}</td><td><button class="btn btn-success btn-sm ver-btn" data-id="${d.id}">Verificar</button></td></tr>`).join(''); } catch(e){}
        }
        document.getElementById('verify-dispatch-table-body').addEventListener('click', async (e) => {
            if(e.target.closest('.ver-btn') && await showCustomConfirm('¬øConfirmar?')) {
                try { await apiFetch(`/despachos/${e.target.closest('.ver-btn').dataset.id}/verificar`, { method: 'PUT' }); showCustomAlert('Verificado', 'success'); cargarDespachosPendientes(); } catch(e) { showCustomAlert(e.message); }
            }
        });

        // Orden Compra
        async function cargarOrdenesStockBajo() {
            try { const data = await apiFetch('/insumos/stock-bajo'); document.getElementById('po-table-body').innerHTML = data.map(i => `<tr><td>${i.nombre}</td><td>${i.stock_actual}</td><td>${i.stock_minimo}</td><td><input type="number" class="po-qty" data-id="${i.id}" value="${(i.stock_minimo*2)-i.stock_actual}"></td></tr>`).join(''); } catch(e){}
        }
        document.getElementById('form-orden-compra').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { await apiFetch('/ordenes-compra', { method: 'POST', body: JSON.stringify({ insumos: Array.from(document.querySelectorAll('.po-qty')).map(i => ({ id_insumo: i.dataset.id, cantidad: i.value })) }) }); showCustomAlert('Orden generada', 'success'); cargarOrdenesStockBajo(); } catch(e) { showCustomAlert(e.message); }
        });

        // Validar Orden
        async function cargarOrdenesPendientes() {
            try { const data = await apiFetch('/ordenes-compra/pendientes'); document.getElementById('validate-table-body').innerHTML = data.map(o => `<tr><td>${o.id}</td><td>${new Date(o.createdAt).toLocaleDateString()}</td><td>${o.solicitante?.nombre}</td><td>-</td><td><button class="btn btn-success btn-sm v-btn" data-id="${o.id}" data-act="validar">‚úì</button></td></tr>`).join(''); } catch(e){}
        }
        document.getElementById('validate-table-body').addEventListener('click', async (e) => {
            const btn = e.target.closest('.v-btn');
            if(btn && await showCustomConfirm('¬øValidar?')) {
                try { await apiFetch(`/ordenes-compra/${btn.dataset.act}/${btn.dataset.id}`, { method: 'POST' }); showCustomAlert('Hecho', 'success'); cargarOrdenesPendientes(); } catch(e) { showCustomAlert(e.message); }
            }
        });

        // Entrada
        async function cargarOrdenesValidadas() {
            try { const data = await apiFetch('/ordenes-compra/validadas'); document.getElementById('entry-table-body').innerHTML = data.map(o => `<tr><td>${o.id}</td><td>${o.validador?.nombre}</td><td>-</td><td><button class="btn btn-success btn-sm ent-btn" data-id="${o.id}">Registrar</button></td></tr>`).join(''); } catch(e){}
        }
        document.getElementById('entry-table-body').addEventListener('click', async (e) => {
            if(e.target.closest('.ent-btn') && await showCustomConfirm('¬øRegistrar entrada?')) {
                try { await apiFetch(`/ordenes-compra/${e.target.closest('.ent-btn').dataset.id}/registrar-entrada`, { method: 'POST' }); showCustomAlert('Entrada OK', 'success'); cargarOrdenesValidadas(); } catch(e) { showCustomAlert(e.message); }
            }
        });

        // Gesti√≥n y Merma
        async function cargarGestionarInsumos() { try { const d = await apiFetch('/insumos'); document.getElementById('gestionar-insumos-table').innerHTML = d.map(i=>`<tr><td>${i.id}</td><td>${i.nombre}</td><td>${i.stock_actual}</td><td><button class="btn btn-danger btn-sm del-btn" data-id="${i.id}">üóë</button></td></tr>`).join(''); } catch(e){} }
        async function cargarInsumosParaMerma() { try { const d = await apiFetch('/insumos'); document.getElementById('merma-insumo-select').innerHTML = '<option value="">Select</option>'+d.map(i=>`<option value="${i.id}">${i.nombre}</option>`).join(''); } catch(e){} }
        
        document.getElementById('form-crear-insumo').addEventListener('submit', async(e)=>{ e.preventDefault(); try { await apiFetch('/insumos', {method:'POST', body:JSON.stringify({nombre:document.getElementById('insumo-nombre').value, categoria:document.getElementById('insumo-categoria').value, stock_actual:document.getElementById('insumo-stock-actual').value, stock_minimo:document.getElementById('insumo-stock-minimo').value, unidad_medida:document.getElementById('insumo-unidad').value})}); showCustomAlert('Creado','success'); cargarGestionarInsumos(); }catch(e){showCustomAlert(e.message);} });
        document.getElementById('form-merma').addEventListener('submit', async(e)=>{ e.preventDefault(); try { await apiFetch('/insumos/merma', {method:'POST', body:JSON.stringify({id_insumo:document.getElementById('merma-insumo-select').value, cantidad:document.getElementById('merma-cantidad').value, motivo:document.getElementById('merma-motivo').value})}); showCustomAlert('Merma OK','success'); }catch(e){showCustomAlert(e.message);} });
        document.getElementById('gestionar-insumos-table').addEventListener('click', async(e)=>{ 
            const btn = e.target.closest('.del-btn');
            if(btn && await showCustomConfirm('¬øEliminar?')) { try{ await apiFetch(`/insumos/${btn.dataset.id}`, {method:'DELETE'}); showCustomAlert('Eliminado','success'); cargarGestionarInsumos(); }catch(e){showCustomAlert(e.message);} }
        });

        async function cargarStock() { try { const d = await apiFetch('/insumos'); document.getElementById('stock-table-body').innerHTML = d.map(i=>`<tr><td>${i.nombre}</td><td>${i.categoria}</td><td>${i.stock_actual}</td><td>-</td></tr>`).join(''); } catch(e){} }

        // PDF
        document.getElementById('btn-exportar-pdf').addEventListener('click', () => {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.text(`Historial Wing Wa - ${new Date().toLocaleDateString()}`, 14, 20);
            doc.autoTable({ html: '#tabla-historial-completa', startY: 30 });
            doc.save('historial.pdf');
        });

        // --- 7. CARGA INICIAL ROBUSTA ---
        (async function init() {
            console.log("Iniciando...");
            try {
                // Precarga de cat√°logos (segura)
                if(user.rol!=='Due√±o') { await cargarInsumosParaSolicitud(); await cargarInsumosParaMerma(); }
                // Precarga de datos seg√∫n rol (si falla uno, no detiene el resto)
                if(user.rol.includes('jefe') || user.rol.includes('chef')) try{ await cargarSolicitudesPendientes(); }catch(e){}
                if(user.rol.includes('encargado')) try{ await cargarOrdenesValidadas(); }catch(e){}
            } catch(e) { console.warn("Error no cr√≠tico en carga inicial", e); }
            showView('view-welcome');
        })();
    });
</script>
</body>
</html>